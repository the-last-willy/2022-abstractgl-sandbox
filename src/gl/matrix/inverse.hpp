#pragma once

#include "matrix.hpp"

namespace tlw {

constexpr
auto inverse(const Mat4& m) {
    auto A2323 = m(2, 2) * m(3, 3) - m(2, 3) * m(3, 2);
    auto A1323 = m(2, 1) * m(3, 3) - m(2, 3) * m(3, 1);
    auto A1223 = m(2, 1) * m(3, 2) - m(2, 2) * m(3, 1);
    auto A0323 = m(2, 0) * m(3, 3) - m(2, 3) * m(3, 0);
    auto A0223 = m(2, 0) * m(3, 2) - m(2, 2) * m(3, 0);
    auto A0123 = m(2, 0) * m(3, 1) - m(2, 1) * m(3, 0);
    auto A2313 = m(1, 2) * m(3, 3) - m(1, 3) * m(3, 2);
    auto A1313 = m(1, 1) * m(3, 3) - m(1, 3) * m(3, 1);
    auto A1213 = m(1, 1) * m(3, 2) - m(1, 2) * m(3, 1);
    auto A2312 = m(1, 2) * m(2, 3) - m(1, 3) * m(2, 2);
    auto A1312 = m(1, 1) * m(2, 3) - m(1, 3) * m(2, 1);
    auto A1212 = m(1, 1) * m(2, 2) - m(1, 2) * m(2, 1);
    auto A0313 = m(1, 0) * m(3, 3) - m(1, 3) * m(3, 0);
    auto A0213 = m(1, 0) * m(3, 2) - m(1, 2) * m(3, 0);
    auto A0312 = m(1, 0) * m(2, 3) - m(1, 3) * m(2, 0);
    auto A0212 = m(1, 0) * m(2, 2) - m(1, 2) * m(2, 0);
    auto A0113 = m(1, 0) * m(3, 1) - m(1, 1) * m(3, 0);
    auto A0112 = m(1, 0) * m(2, 1) - m(1, 1) * m(2, 0);

    auto det = m(0, 0) * (m(1, 1) * A2323 - m(1, 2) * A1323 + m(1, 3) * A1223)
        - m(0, 1) * (m(1, 0) * A2323 - m(1, 2) * A0323 + m(1, 3) * A0223)
        + m(0, 2) * (m(1, 0) * A1323 - m(1, 1) * A0323 + m(1, 3) * A0123)
        - m(0, 3) * (m(1, 0) * A1223 - m(1, 1) * A0223 + m(1, 2) * A0123);
    det = 1 / det;

    auto i = Mat4();
    i(0, 0) = det *   (m(1, 1) * A2323 - m(1, 2) * A1323 + m(1, 3) * A1223);
    i(0, 1) = det * - (m(0, 1) * A2323 - m(0, 2) * A1323 + m(0, 3) * A1223);
    i(0, 2) = det *   (m(0, 1) * A2313 - m(0, 2) * A1313 + m(0, 3) * A1213);
    i(0, 3) = det * - (m(0, 1) * A2312 - m(0, 2) * A1312 + m(0, 3) * A1212);
    i(1, 0) = det * - (m(1, 0) * A2323 - m(1, 2) * A0323 + m(1, 3) * A0223);
    i(1, 1) = det *   (m(0, 0) * A2323 - m(0, 2) * A0323 + m(0, 3) * A0223);
    i(1, 2) = det * - (m(0, 0) * A2313 - m(0, 2) * A0313 + m(0, 3) * A0213);
    i(1, 3) = det *   (m(0, 0) * A2312 - m(0, 2) * A0312 + m(0, 3) * A0212);
    i(2, 0) = det *   (m(1, 0) * A1323 - m(1, 1) * A0323 + m(1, 3) * A0123);
    i(2, 1) = det * - (m(0, 0) * A1323 - m(0, 1) * A0323 + m(0, 3) * A0123);
    i(2, 2) = det *   (m(0, 0) * A1313 - m(0, 1) * A0313 + m(0, 3) * A0113);
    i(2, 3) = det * - (m(0, 0) * A1312 - m(0, 1) * A0312 + m(0, 3) * A0112);
    i(3, 0) = det * - (m(1, 0) * A1223 - m(1, 1) * A0223 + m(1, 2) * A0123);
    i(3, 1) = det *   (m(0, 0) * A1223 - m(0, 1) * A0223 + m(0, 2) * A0123);
    i(3, 2) = det * - (m(0, 0) * A1213 - m(0, 1) * A0213 + m(0, 2) * A0113);
    i(3, 3) = det *   (m(0, 0) * A1212 - m(0, 1) * A0212 + m(0, 2) * A0112);
    return i;
}

}
